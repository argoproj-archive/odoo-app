---
type: workflow
version: 1
name: odoo-workflow-with-volumes
description: This is the workflow to load Odoo data into postgres

inputs:
  parameters:
    APP_NAME:
      default: "odoo-with-vols"
    DATA_VOL_NAME:
      default: "postgres"
    APP_VOL_NAME:
      default: "odoo"
    USER:
      default: "odoo"
    PASSWORD:
      default: "odoo"

steps:
- deploy-postgres:
        template: postgres-deployment-with-vol
- deploy-odoo:
        template: odoo-deployment-with-vols

---
type: deployment
version: 1 
name: postgres-deployment-with-vol
description: Postgres deployment

application_name:  "%%inputs.parameters.APP_NAME%%"
deployment_name: "postgres-deployment"

inputs:
  parameters:
    APP_NAME:
      default: "odoo-app-vol"
    DATA_VOL_NAME:
    USER:
    PASSWORD:

volumes:
  data-vol:
    name: "%%inputs.parameters.DATA_VOL_NAME%%"

scale:
  min: 1

internal_routes:
- name: db
  ports:
  - port: 5432
    target_port: 5432

containers:
  postgres-container:

    inputs:
      volumes:
        data-vol:
          from: "%%volumes.data-vol%%"
          mount_path: /var/lib/postgresql/data
      
    image: "postgres:9.6.1"
    env:
    - name: PGDATA
      value: /var/lib/postgresql/data/pgdata
    - name: POSTGRES_USER
      value: "%%inputs.parameters.USER%%"
    - name: POSTGRES_PASSWORD
      value: "%%inputs.parameters.PASSWORD%%" 
    resources:
      mem_mib: 1024
      cpu_cores: 0.5

---
type: deployment
version: 1
name: odoo-deployment-with-vols
description: Odoo deployment

application_name: "%%inputs.parameters.APP_NAME%%"
deployment_name: "odoo-deploy"

inputs:
  parameters:
    APP_NAME:
        default: "odoo-app-vol"
    APP_VOL_NAME:

volumes:
  app-vol:
    name: "%%inputs.parameters.APP_VOL_NAME%%"

scale:
  min: 1

external_routes:
- dns_prefix: "odoo"
  target_port: 8069
  ip_white_list:
  - 0.0.0.0/0

containers:
  odoo-container:

    inputs:
      volumes:
        app-vol:
          from: "%%volumes.app-vol%%"
          mount_path: /var/lib/odoo

    image: "odoo:10.0"
    resources:
      mem_mib: 800
      cpu_cores: 0.4


